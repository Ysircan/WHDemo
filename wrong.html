<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“˜ é”™é¢˜æœ¬ï¼ˆç‚¹è¯è§£é‡Šï¼‰</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
    }
    .main-container {
      max-width: 900px;
      margin: auto;
      padding: 30px;
    }
    h2 {
      text-align: center;
      color: #007bff;
    }
    .date-selector {
      margin: 20px 0;
      font-size: 16px;
    }
    .wrong-item {
      background: white;
      padding: 15px 20px;
      margin-bottom: 20px;
      border-left: 5px solid #dc3545;
      border-radius: 8px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.05);
    }
   .word-container {
  display: inline-flex;
  align-items: flex-start;
  gap: 10px;
  flex-wrap: wrap;
  margin-top: 8px;
}

.word-block {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-right: 12px;
}

.word {
  cursor: pointer;
  color: #007bff;
  font-weight: bold;
  padding: 2px 6px;
  border-radius: 4px;
  background-color: #fceabb;
  margin-bottom: 4px;
}

.ai-result {
  background: #eef4ff;
  padding: 6px 10px;
  border-radius: 4px;
  font-size: 13px;
  max-width: 180px;
  box-shadow: 0 0 4px rgba(0,0,0,0.1);
}

    .delete-day {
      float: right;
      background: transparent;
      color: #dc3545;
      border: none;
      font-weight: bold;
      cursor: pointer;
    }
    .navbar {
  background-color: #007bff;
  width: 100vw;
  padding: 14px 40px;
  box-sizing: border-box;
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin: 0;
}

.nav-left {
  display: flex;
  gap: 30px;
  align-items: center;
}

.nav-link {
  color: #ffffff;
  text-decoration: none;
  font-weight: bold;
  font-size: 16px;
  transition: color 0.2s;
}

.nav-link:hover {
  color: #ffd700;
}
  </style>
</head>
<body>
<div class="navbar">
  <div class="nav-left">
    <a href="draw.html" class="nav-link">ğŸƒ æŠ½å¡</a>
    <a href="gallery.html" class="nav-link">ğŸ–¼ å›¾é‰´</a>
    <a href="audio.html" class="nav-link">ğŸ§ å¬åŠ›ç»ƒä¹ </a>
    <a href="wrong.html" class="nav-link">ğŸ“˜ é”™é¢˜æœ¬</a>
    <a href="home.html" class="nav-link">ğŸ  ä¸»é¡µ</a>
  </div>
  
</div>
  <div class="main-container">
    <h2>ğŸ“˜ é”™é¢˜é›† Â· æ¯æ—¥å›é¡¾</h2>

    <label class="date-selector">é€‰æ‹©æ—¥æœŸï¼š
      <select id="dateSelect" onchange="renderWrongList()"></select>
    </label>

    <div id="wrongList">åŠ è½½ä¸­...</div>
  </div>

  <script>
    const apiKey = "Bearer cd36d50e081044d99e1d32351c52cc98.zFxAEVWLHCmFuS2n";
    const data = JSON.parse(localStorage.getItem("wrongRecords") || "{}");
    const select = document.getElementById("dateSelect");
    const list = document.getElementById("wrongList");

    const allDates = Object.keys(data).sort().reverse();
    if (allDates.length === 0) {
      list.innerHTML = "<p>ğŸ‰ æ²¡æœ‰é”™é¢˜ï¼ŒçœŸæ£’ï¼</p>";
    } else {
      select.innerHTML = allDates.map(d => `<option value="${d}">${d}</option>`).join("");
      renderWrongList();
    }

    function renderWordClickable(words, resIdPrefix) {
  return `
    <div class="word-container">
      ${words.split(/[,ï¼Œ\s]+/).map((word, idx) => {
        const resultId = `${resIdPrefix}-${idx}`;
        return `
          <div class="word-block">
            <span class="word" onclick="searchWord('${word}', '${resultId}')">${word}</span>
            <div class="ai-result" id="${resultId}"></div>
          </div>
        `;
      }).join("")}
    </div>
  `;
}


    function renderWrongList() {
      const date = select.value;
      const wrongs = data[date];
      if (!wrongs || wrongs.length === 0) {
        list.innerHTML = "<p>è¿™ä¸€å¤©æ²¡æœ‰é”™é¢˜ã€‚</p>";
        return;
      }

      let html = `<button class="delete-day" onclick="deleteDay('${date}')">ğŸ—‘ æ¸…ç©ºè¿™å¤©</button>`;
      html += wrongs.map((item, index) => {
        const resId = `res-${date}-${index}`;
        if (item.type === "word") {
          return `
            <div class="wrong-item">
              <b>âŒ å•è¯é¢˜ï¼š</b> ${item.question}<br>
              ä½ çš„ç­”æ¡ˆï¼š<span style="color:red">${item.userAnswer}</span><br>
              æ­£ç¡®ç­”æ¡ˆï¼š${renderWordClickable(item.correct, resId)}
              <button class="word" onclick="searchWord('${item.question}', '${resId}-all')">ğŸŒŸ AI ç‚¹ä¸€ä¸‹æ•´ä½“</button>
              <div class="ai-result" id="${resId}-all"></div>
            </div>
          `;
        } else if (item.type === "listening") {
          const inputs = item.userAnswers.join(", ");
          const answers = item.correctBlanks.join(", ");
          return `
            <div class="wrong-item">
              <b>ğŸ§ å¬åŠ›é¢˜ï¼š</b> ${item.sentence.replace(/___/g, "_____")}<br>
              ä½ çš„ç­”æ¡ˆï¼š<span style="color:red">${inputs}</span><br>
              æ­£ç¡®ç­”æ¡ˆï¼š${renderWordClickable(answers, resId)}
            </div>
          `;
        }
      }).join("");

      list.innerHTML = html;
    }

    async function searchWord(word, resultId) {
      const div = document.getElementById(resultId);
      if (!div) return;
      div.innerHTML = `<em>æ­£åœ¨æŸ¥æ‰¾ â€œ${word}â€...</em>`;

      const prompt = `è¯·æ ¹æ®ç”¨æˆ·è¾“å…¥çš„è‹±æ–‡å•è¯ "${word}"ï¼ŒæŒ‰ä»¥ä¸‹æ ¼å¼è¿”å›å†…å®¹ï¼š
[ä¸­æ–‡é‡Šä¹‰] ä¸­æ–‡æ„æ€ï¼ˆæœ€å¤š10å­—ï¼‰
[è‹±æ–‡ä¾‹å¥] å«æœ‰ ${word} çš„è‹±æ–‡å¥å­
[é¼“åŠ±è¯è¯­] é¼“åŠ±ä¸€å¥`;

      try {
        const res = await fetch("https://open.bigmodel.cn/api/paas/v3/model-api/chatglm_turbo/invoke", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": apiKey
          },
          body: JSON.stringify({ prompt, temperature: 0.7, top_p: 0.9 })
        });

        const data = await res.json();
        const content = data.data?.choices?.[0]?.content || "";

        const extract = (label) => {
          const match = content.match(new RegExp(`\\[${label}\\](.*?)($|\\[)`, 's'));
          return match ? match[1].trim() : "ï¼ˆæ— å†…å®¹ï¼‰";
        };

        div.innerHTML = `
          <div><strong>ğŸ“Œ ä¸­æ–‡é‡Šä¹‰ï¼š</strong> ${extract("ä¸­æ–‡é‡Šä¹‰")}</div>
          <div><strong>ğŸ’¬ è‹±æ–‡ä¾‹å¥ï¼š</strong> ${extract("è‹±æ–‡ä¾‹å¥")}</div>
          <div><strong>ğŸŒŸ é¼“åŠ±è¯è¯­ï¼š</strong> ${extract("é¼“åŠ±è¯è¯­")}</div>
        `;
      } catch (err) {
        div.innerHTML = "<em>è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ– API Keyã€‚</em>";
      }
    }

    function deleteDay(date) {
      if (confirm(`ç¡®è®¤è¦åˆ é™¤ ${date} çš„æ‰€æœ‰é”™é¢˜å—ï¼Ÿ`)) {
        delete data[date];
        localStorage.setItem("wrongRecords", JSON.stringify(data));
        location.reload();
      }
    }
  </script>
</body>
</html>
